{% extends 'base.html' %}

{% block content %}
    {% include 'login_container.html' %}

    {% if not request.user %}
        <script src="https://cdn.jsdelivr.net/gh/Joe12387/detectIncognito@main/detectIncognito.min.js"></script>
        <script>
            detectIncognito().then((result) => {
                if (!result.isPrivate) return;
                let iframeContainer = document.getElementById("iframe-container");
                iframeContainer.innerHTML =
                    `<h3 style='text-align: center; padding: 20px'>
                        Sorry! We can't let you use this app in incognito mode. Please login to continue.
                    </h3>`;

            });
        </script>
    {% endif %}


    <div id="iframe-container">
        <iframe onload="onIframeLoaded(this)"
                src="{{ iframe_url }}"
                allow="clipboard-read; clipboard-write; accelerometer; ambient-light-sensor; autoplay; battery; camera; document-domain; encrypted-media; fullscreen; geolocation; gyroscope; layout-animations; legacy-image-formats; magnetometer; microphone; midi; oversized-images; payment; picture-in-picture; publickey-credentials-get; sync-xhr; usb; vr ; wake-lock; xr-spatial-tracking">
        </iframe>
    </div>

    <script>
        function onIframeLoaded(iframe) {
            window.addEventListener('message', function (event) {
                switch (event.data.type) {
                    case "GOOEY_SET_QUERY_PARAM":
                        let searchParams = new URLSearchParams();
                        for (let [key, value] of Object.entries(event.data.queryParams)) {
                            searchParams.set(key, value);
                        }
                        let url = new URL(window.location.href);
                        url.search = searchParams.toString();
                        history.pushState(null, '', url.toString());
                        break;

                    case "GOOEY_IFRAME_RESIZE":
                        iframe.style.height = `${event.data.height + 100}px`;
                        break;
                }
            });
        }
    </script>
{% endblock content %}
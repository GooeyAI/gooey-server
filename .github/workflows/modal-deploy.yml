name: Modal Deployment
permissions:
  contents: read

on:
  push:
    branches:
      - master
    paths:
      - 'modal_functions/*.py'
      - '.github/workflows/modal-deploy.yml'
  workflow_dispatch:
    inputs:
      file:
        description: 'Python file to deploy (e.g., modal_functions/mms_tts.py)'
        required: true
        default: 'modal_functions/mms_tts.py'

jobs:
  deploy:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        python-version: ["3.10.12"]
        poetry-version: ["1.8.3"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python, Poetry and Dependencies
        uses: packetcoders/action-setup-cache-python-poetry@main
        with:
          python-version: ${{matrix.python-version}}
          poetry-version: ${{matrix.poetry-version}}
          install-args: --only main

      - name: Set up Modal
        run: |
          poetry run pip install modal

      - name: Authenticate with Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: |
          poetry run modal token set --token-id $MODAL_TOKEN_ID --token-secret $MODAL_TOKEN_SECRET

      - name: Detect changed files
        id: changed-files
        if: github.event_name == 'push'
        run: |
          echo "Detecting changed Modal files..."
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '^modal_functions/.*\.py$' || true)
          if [ -z "$CHANGED_FILES" ]; then
            echo "No Modal deployment files changed"
            echo "files=" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            # Convert to space-separated list
            FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_LIST" >> $GITHUB_OUTPUT
          fi

      - name: Deploy to Modal
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual trigger - deploy specified file
            FILE="${{ github.event.inputs.file }}"
            echo "Deploying manually specified file: $FILE"
            poetry run modal deploy $FILE
          else
            # Push trigger - deploy changed files
            FILES="${{ steps.changed-files.outputs.files }}"
            if [ -z "$FILES" ]; then
              echo "No Modal deployment files to deploy"
              exit 0
            fi
            for FILE in $FILES; do
              echo "Deploying: $FILE"
              poetry run modal deploy $FILE
            done
          fi
